import{_ as T}from"./SurveyJsWrapper.vue_vue_type_script_setup_true_lang.1350c34a.js";import{_ as Y,o as m,c as L,p as $,b as A,e as d,f as F,y as G,w as H,h as s,x as p,Q as M,B as K,k as w,j,v as Q,m as C,C as q,R as z,S as J,D as W}from"./index.edeb006c.js";import{u as X}from"./surveyStore.564d0932.js";import{l as Z,s as ee,c as te}from"./surveyStorage.34c3760f.js";const ae="/assets/survey-complete.0b18e9c3.svg";const oe={},x=r=>($("data-v-548baabb"),r=r(),A(),r),se={class:"survey-complete-page"},re=x(()=>d("img",{src:ae,alt:"Complete",draggable:"false"},null,-1)),ne=x(()=>d("div",{class:"scp-text"},[d("h4",null,"Thank you for completing this survey"),d("h5",null,"Please don't close this browser tab, we're redirecting you back to your surveys")],-1)),ue=[re,ne];function ce(r,a){return m(),L("article",se,ue)}const le=Y(oe,[["render",ce],["__scopeId","data-v-548baabb"]]),ie={key:0},_e=F({__name:"UserSurveyView",props:{surveyId:null},setup(r){const a=r,{user:U}=W(),B=X(),o=G(),n=H(),y=q(),u=s(()=>{var e,t;return(t=(e=U.value)==null?void 0:e.user_metadata.participantId)!=null?t:""}),l=s(()=>n.getCachedParticipant(u.value)),N=s(()=>n.getCachedParticipantSurveys(u.value)),h=s(()=>{var e;return(e=N.value)==null?void 0:e.find(t=>t.id===a.surveyId)}),i=s(()=>{var e;return(e=h.value)==null?void 0:e.survey}),V=s(()=>!!(l.value&&i.value)),_=p(),f=p(),S=p(),g=s(()=>`userSurvey:${a.surveyId}`),I=p(!1);async function P(e=!1){if(await Promise.all([n.cacheParticipant(u.value),n.cacheParticipantSurveys(u.value,e),n.cacheParticipantProtocolEntries(u.value,e)]),!i.value)throw new Error(`Could not find the survey: ${a.surveyId}`)}M(async()=>{const e=Z(g.value);_.value=e.oldData,f.value=e.oldPageIndex;try{o.openLoadingOverlay(),await P(!0)}catch(t){console.error("Unable to download participant info",t),y.push({path:"/survey-not-found"})}finally{o.closeLoadingOverlay()}});function k(e){o.setPageCount(e.pageCount),o.setShowProgressBar(!0),b(e.currentPageNo,null,e.currentPage.name)}K(()=>{o.setShowProgressBar(!1)});function b(e,t,c){if(o.setPageIndex(e),o.setPageTitle(c),S.value!==e){S.value=e;const v=[];t===null?v.push({event_type:_.value?"CONTINUE_SURVEY":"BEGIN_SURVEY",surveyId:a.surveyId}):v.push({event_type:"FINISH_SURVEY_PAGE",page_index:t,surveyId:a.surveyId}),v.push({event_type:"OPEN_SURVEY_PAGE",page_index:e,surveyId:a.surveyId}),E(...v)}}function R(e,t){ee(g.value,e,t)}function D(e){o.setHelpKey(e)}async function O(e,t){if(!V.value)throw new Error("On complete shouldn't trigger before we're loaded");I.value=!0;try{await Promise.all([z(l.value,h.value,e),E({event_type:"FINISH_SURVEY_PAGE",page_index:t,surveyId:a.surveyId},{event_type:"COMPLETE_SURVEY",surveyId:a.surveyId})]),B.completedSurveys[a.surveyId]=!0,te(g.value),o.setShowProgressBar(!1),await new Promise(c=>setTimeout(c,2e3)),y.push({path:"/user-home"})}catch(c){console.error("Unable to submit survey",c),y.push({path:"/error-page"})}}async function E(...e){await P();const t=await n.getEventLogProtocolId(u.value);if(!l.value||!t)throw new Error("Unable to post event log: participant or eventLogProtocolId is null");J(l.value,t,e)}return(e,t)=>w(i)?(m(),L("div",ie,[j(T,{"survey-data":w(i),"initial-state":_.value,"initial-page-idx":f.value,onComplete:O,onLoaded:k,onPageChanged:b,onPartialSend:R,onHelp:D},null,8,["survey-data","initial-state","initial-page-idx"]),I.value?(m(),Q(le,{key:0})):C("",!0)])):C("",!0)}});export{_e as default};
