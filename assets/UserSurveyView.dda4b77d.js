import{_ as A,o as _,c as D,p as $,a as H,b as v,B as M,C as j,E as F,d as K,m as Y,e as u,l as h,D as q,q as z,g as b,f as J,k as G,h as C,v as Q,s as W}from"./index.55b9e926.js";import{_ as X}from"./SurveyJsWrapper.vue_vue_type_script_setup_true_lang.16ed083e.js";import{u as Z}from"./surveyStore.6c272882.js";import{u as ee}from"./participantStore.1b8c794b.js";import{l as te,c as oe,s as ae}from"./surveyStorage.34c3760f.js";import"./storeHelpers.0f9f5153.js";const ne="/bdi-under-the-radar-dev.github.io/assets/complete.da7ee872.svg";const se={},E=e=>($("data-v-2871fe08"),e=e(),H(),e),re={class:"survey-complete-page"},ie=E(()=>v("img",{src:ne,alt:"Complete",draggable:"false"},null,-1)),ce=E(()=>v("div",{class:"scp-text"},[v("h4",null,"Thank you for completing this survey"),v("h5",null,"Please don't close this browser tab, we're redirecting you back to your surveys")],-1)),ue=[ie,ce];function de(e,t){return _(),D("article",re,ue)}const le=A(se,[["render",de],["__scopeId","data-v-2871fe08"]]);let m;const pe=new Uint8Array(16);function ye(){if(!m&&(m=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!m))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return m(pe)}const a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));function me(e,t=0){return(a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]).toLowerCase()}const ve=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),U={randomUUID:ve};function ge(e,t,c){if(U.randomUUID&&!t&&!e)return U.randomUUID();e=e||{};const s=e.random||(e.rng||ye)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,t){c=c||0;for(let i=0;i<16;++i)t[c+i]=s[i];return t}return me(s)}async function he(e,t){const c=new URL("submissions",F),s={"Content-Type":"application/json"};t&&(s.Authorization=`Bearer ${t}`);const i=await fetch(c,{method:"POST",headers:s,body:JSON.stringify(e)});if(!i.ok){const l=`An error has occured: ${i.status}`;throw console.error(i),new Error(l)}}async function _e(e,t,c,s){const i=M(),n=j().getCurrentOffsetTime().toISOString(),d={id:ge(),payloadType:"SURVEY_RESPONSE",payload:{type:"SURVEY_RESPONSE",surveyResponse:{surveyName:t.name,surveyVersion:t.version,surveyType:t.surveyType,interventionId:t.interventionId,recordedAt:n,surveyResponse:c}},experimentId:e._embedded.trial.experiment.id,participantId:e.id,clientInfo:i,metadata:"",initiatedAt:n,submittedAt:n,protocolEntryId:t.id,trialId:e._embedded.trial.id};return he(d,s)}const Se={key:0},Ce=K({__name:"UserSurveyView",props:{surveyId:null},setup(e){const t=e,{user:c,getAccessTokenSilently:s}=Q(),i=c,l=Z(),n=Y(),d=ee(),S=W(),p=u(()=>i.value.user_metadata.participantId),I=u(()=>d.getCachedParticipant(p.value)),T=u(()=>d.getCachedParticipantSurveys(p.value)),f=u(()=>{var o;return(o=T.value)==null?void 0:o.find(r=>r.id===t.surveyId)}),y=u(()=>{var o;return(o=f.value)==null?void 0:o.survey}),O=u(()=>!!(I.value&&y.value)),w=h(),P=h(),g=u(()=>`userSurvey:${t.surveyId}`),x=h(!1);q(async()=>{const o=te(g.value);w.value=o.oldData,P.value=o.oldPageIndex;try{n.openLoadingOverlay();const r=await s();if(await Promise.all([d.cacheParticipant(p.value,r),d.cacheParticipantSurveys(p.value,r,!0)]),!y.value)throw new Error(`Could not find the survey: ${t.surveyId}`)}catch(r){console.error("Unable to download participant info",r),S.push({path:"/survey-not-found"})}finally{n.closeLoadingOverlay()}});async function k(o){if(!O.value)throw new Error("On complete shouldn't trigger before we're loaded");const r=await s();await _e(I.value,f.value,o,r),x.value=!0,l.completedSurveys[t.surveyId]=!0,oe(g.value),n.setShowProgressBar(!1),await new Promise(N=>setTimeout(N,2e3)),S.push({path:"/user-home"})}function R(o){n.setPageCount(o.pageCount),n.setPageTitle(o.currentPage.name),n.setPageIndex(o.currentPageNo),n.setShowProgressBar(!0)}z(()=>{n.setShowProgressBar(!1)});function V(o,r){n.setPageIndex(o),n.setPageTitle(r)}function B(o,r){ae(g.value,o,r)}function L(o){n.setHelpKey(o)}return(o,r)=>b(y)?(_(),D("div",Se,[J(X,{"survey-data":b(y),"initial-state":w.value,"initial-page-idx":P.value,onOnComplete:k,onOnLoaded:R,onOnPageChanged:V,onOnPartialSend:B,onHelp:L},null,8,["survey-data","initial-state","initial-page-idx"]),x.value?(_(),G(le,{key:0})):C("",!0)])):C("",!0)}});export{Ce as default};
