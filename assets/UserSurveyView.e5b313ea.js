import{_ as M}from"./SurveyJsWrapper.vue_vue_type_script_setup_true_lang.f08f0c99.js";import{_ as j,o as E,c as T,p as K,d as q,e as S,Q as N,R as O,S as z,T as J,f as Q,v as W,g as l,s as _,U as X,x as Z,i as V,h as ee,q as te,k as L,y as oe,z as ae}from"./index.643b78dc.js";import{u as ne}from"./surveyStore.49996db6.js";import{u as re}from"./participantStore.32858037.js";import{l as se,s as ue,c as ie}from"./surveyStorage.34c3760f.js";import"./storeHelpers.9feef9ab.js";const ce="/assets/complete.da7ee872.svg";const de={},D=e=>(K("data-v-2871fe08"),e=e(),q(),e),le={class:"survey-complete-page"},pe=D(()=>S("img",{src:ce,alt:"Complete",draggable:"false"},null,-1)),ve=D(()=>S("div",{class:"scp-text"},[S("h4",null,"Thank you for completing this survey"),S("h5",null,"Please don't close this browser tab, we're redirecting you back to your surveys")],-1)),ye=[pe,ve];function me(e,t){return E(),T("article",le,ye)}const _e=j(de,[["render",me],["__scopeId","data-v-2871fe08"]]);let g;const ge=new Uint8Array(16);function Se(){if(!g&&(g=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!g))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return g(ge)}const r=[];for(let e=0;e<256;++e)r.push((e+256).toString(16).slice(1));function he(e,t=0){return(r[e[t+0]]+r[e[t+1]]+r[e[t+2]]+r[e[t+3]]+"-"+r[e[t+4]]+r[e[t+5]]+"-"+r[e[t+6]]+r[e[t+7]]+"-"+r[e[t+8]]+r[e[t+9]]+"-"+r[e[t+10]]+r[e[t+11]]+r[e[t+12]]+r[e[t+13]]+r[e[t+14]]+r[e[t+15]]).toLowerCase()}const Ie=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),R={randomUUID:Ie};function A(e,t,i){if(R.randomUUID&&!t&&!e)return R.randomUUID();e=e||{};const s=e.random||(e.rng||Se)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,t){i=i||0;for(let a=0;a<16;++a)t[i+a]=s[a];return t}return he(s)}async function k(e){const t=new URL("submissions",z),s=await J(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){const a=`An error has occured: ${s.status}`;throw console.error(s),new Error(a)}}async function Ee(e,t,i){const s=N(),u=O().getCurrentOffsetTime().toISOString(),d={id:A(),payloadType:"SURVEY_RESPONSE",payload:{type:"SURVEY_RESPONSE",surveyResponse:{surveyName:t.name,surveyVersion:t.version,surveyType:t.surveyType,interventionId:t.interventionId,recordedAt:u,surveyResponse:i}},experimentId:e._embedded.trial.experiment.id,participantId:e.id,clientInfo:s,metadata:"",initiatedAt:u,submittedAt:u,protocolEntryId:t.id,trialId:e._embedded.trial.id};return k(d)}async function fe(e,t,i){const s=N(),u=O().getCurrentOffsetTime().toISOString(),d={id:A(),payloadType:"EVENT_LOG",payload:{type:"EVENT_LOG",eventLogs:i.map(c=>({event:c,recordedAt:u}))},experimentId:e._embedded.trial.experiment.id,participantId:e.id,clientInfo:s,metadata:"",initiatedAt:u,submittedAt:u,protocolEntryId:t,trialId:e._embedded.trial.id};return k(d)}const Pe={key:0},Le=Q({__name:"UserSurveyView",props:{surveyId:null},setup(e){const t=e,{user:i}=ae(),s=ne(),a=W(),u=re(),d=oe(),c=l(()=>{var o,n;return(n=(o=i.value)==null?void 0:o.user_metadata.participantId)!=null?n:""}),v=l(()=>u.getCachedParticipant(c.value)),B=l(()=>u.getCachedParticipantSurveys(c.value)),f=l(()=>{var o;return(o=B.value)==null?void 0:o.find(n=>n.id===t.surveyId)}),y=l(()=>{var o;return(o=f.value)==null?void 0:o.survey}),Y=l(()=>!!(v.value&&y.value)),h=_(),P=_(),b=_(),I=l(()=>`userSurvey:${t.surveyId}`),U=_(!1);async function w(o=!1){if(await Promise.all([u.cacheParticipant(c.value),u.cacheParticipantSurveys(c.value,o),u.cacheParticipantProtocolEntries(c.value,o)]),!y.value)throw new Error(`Could not find the survey: ${t.surveyId}`)}X(async()=>{const o=se(I.value);h.value=o.oldData,P.value=o.oldPageIndex;try{a.openLoadingOverlay(),await w(!0)}catch(n){console.error("Unable to download participant info",n),d.push({path:"/survey-not-found"})}finally{a.closeLoadingOverlay()}});function G(o){a.setPageCount(o.pageCount),a.setShowProgressBar(!0),x(o.currentPageNo,null,o.currentPage.name)}Z(()=>{a.setShowProgressBar(!1)});function x(o,n,p){if(a.setPageIndex(o),a.setPageTitle(p),b.value!==o){b.value=o;const m=[];n===null?m.push({event_type:h.value?"CONTINUE_SURVEY":"BEGIN_SURVEY",surveyId:t.surveyId}):m.push({event_type:"FINISH_SURVEY_PAGE",page_index:n,surveyId:t.surveyId}),m.push({event_type:"OPEN_SURVEY_PAGE",page_index:o,surveyId:t.surveyId}),C(...m)}}function $(o,n){ue(I.value,o,n)}function H(o){a.setHelpKey(o)}async function F(o,n){if(!Y.value)throw new Error("On complete shouldn't trigger before we're loaded");U.value=!0;try{await Promise.all([Ee(v.value,f.value,o),C({event_type:"FINISH_SURVEY_PAGE",page_index:n,surveyId:t.surveyId},{event_type:"COMPLETE_SURVEY",surveyId:t.surveyId})]),s.completedSurveys[t.surveyId]=!0,ie(I.value),a.setShowProgressBar(!1),await new Promise(p=>setTimeout(p,2e3)),d.push({path:"/user-home"})}catch(p){console.error("Unable to submit survey",p),d.push({path:"/error-page"})}}async function C(...o){await w();const n=await u.getEventLogProtocolId(c.value);if(!v.value||!n)throw new Error("Unable to post event log: participant or eventLogProtocolId is null");fe(v.value,n,o)}return(o,n)=>V(y)?(E(),T("div",Pe,[ee(M,{"survey-data":V(y),"initial-state":h.value,"initial-page-idx":P.value,onComplete:F,onLoaded:G,onPageChanged:x,onPartialSend:$,onHelp:H},null,8,["survey-data","initial-state","initial-page-idx"]),U.value?(E(),te(_e,{key:0})):L("",!0)])):L("",!0)}});export{Le as default};
