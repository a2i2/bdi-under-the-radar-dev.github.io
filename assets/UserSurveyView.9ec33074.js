import{_ as N}from"./SurveyJsWrapper.vue_vue_type_script_setup_true_lang.3b57ece5.js";import{_ as $,o as h,c as D,p as H,a as M,b as v,B as j,C as F,E as K,d as Y,m as q,e as i,l as _,D as z,q as J,g as C,f as W,k as G,h as b,s as Q}from"./index.1df0607d.js";import{u as X}from"./surveyStore.e014db6b.js";import{u as Z}from"./participantStore.574922cc.js";import{l as ee,c as te,s as oe}from"./surveyStorage.34c3760f.js";import{u as ae}from"./authUtils.c6bc9e63.js";const ne="/assets/complete.da7ee872.svg";const se={},E=e=>(H("data-v-2871fe08"),e=e(),M(),e),re={class:"survey-complete-page"},ce=E(()=>v("img",{src:ne,alt:"Complete",draggable:"false"},null,-1)),ue=E(()=>v("div",{class:"scp-text"},[v("h4",null,"Thank you for completing this survey"),v("h5",null,"Please don't close this browser tab, we're redirecting you back to your surveys")],-1)),ie=[ce,ue];function de(e,t){return h(),D("article",re,ie)}const le=$(se,[["render",de],["__scopeId","data-v-2871fe08"]]);let y;const pe=new Uint8Array(16);function me(){if(!y&&(y=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!y))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return y(pe)}const a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));function ye(e,t=0){return(a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]).toLowerCase()}const ve=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),U={randomUUID:ve};function ge(e,t,u){if(U.randomUUID&&!t&&!e)return U.randomUUID();e=e||{};const s=e.random||(e.rng||me)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,t){u=u||0;for(let c=0;c<16;++c)t[u+c]=s[c];return t}return ye(s)}async function _e(e,t){const u=new URL("submissions",K),s={"Content-Type":"application/json"};t&&(s.Authorization=`Bearer ${t}`);const c=await fetch(u,{method:"POST",headers:s,body:JSON.stringify(e)});if(!c.ok){const l=`An error has occured: ${c.status}`;throw console.error(c),new Error(l)}}async function he(e,t,u,s){const c=j(),n=F().getCurrentOffsetTime().toISOString(),d={id:ge(),payloadType:"SURVEY_RESPONSE",payload:{type:"SURVEY_RESPONSE",surveyResponse:{surveyName:t.name,surveyVersion:t.version,surveyType:t.surveyType,interventionId:t.interventionId,recordedAt:n,surveyResponse:u}},experimentId:e._embedded.trial.experiment.id,participantId:e.id,clientInfo:c,metadata:"",initiatedAt:n,submittedAt:n,protocolEntryId:t.id,trialId:e._embedded.trial.id};return _e(d,s)}const Se={key:0},be=Y({__name:"UserSurveyView",props:{surveyId:null},setup(e){const t=e,{user:u,getAccessTokenOrRedirect:s}=ae(),c=u,l=X(),n=q(),d=Z(),S=Q(),p=i(()=>c.value.user_metadata.participantId),f=i(()=>d.getCachedParticipant(p.value)),O=i(()=>d.getCachedParticipantSurveys(p.value)),I=i(()=>{var o;return(o=O.value)==null?void 0:o.find(r=>r.id===t.surveyId)}),m=i(()=>{var o;return(o=I.value)==null?void 0:o.survey}),T=i(()=>!!(f.value&&m.value)),w=_(),P=_(),g=i(()=>`userSurvey:${t.surveyId}`),x=_(!1);z(async()=>{const o=ee(g.value);w.value=o.oldData,P.value=o.oldPageIndex;try{n.openLoadingOverlay();const r=await s();if(await Promise.all([d.cacheParticipant(p.value,r),d.cacheParticipantSurveys(p.value,r,!0)]),!m.value)throw new Error(`Could not find the survey: ${t.surveyId}`)}catch(r){console.error("Unable to download participant info",r),S.push({path:"/survey-not-found"})}finally{n.closeLoadingOverlay()}});async function R(o){if(!T.value)throw new Error("On complete shouldn't trigger before we're loaded");const r=await s();await he(f.value,I.value,o,r),x.value=!0,l.completedSurveys[t.surveyId]=!0,te(g.value),n.setShowProgressBar(!1),await new Promise(A=>setTimeout(A,2e3)),S.push({path:"/user-home"})}function k(o){n.setPageCount(o.pageCount),n.setPageTitle(o.currentPage.name),n.setPageIndex(o.currentPageNo),n.setShowProgressBar(!0)}J(()=>{n.setShowProgressBar(!1)});function V(o,r){n.setPageIndex(o),n.setPageTitle(r)}function B(o,r){oe(g.value,o,r)}function L(o){n.setHelpKey(o)}return(o,r)=>C(m)?(h(),D("div",Se,[W(N,{"survey-data":C(m),"initial-state":w.value,"initial-page-idx":P.value,onOnComplete:R,onOnLoaded:k,onOnPageChanged:V,onOnPartialSend:B,onHelp:L},null,8,["survey-data","initial-state","initial-page-idx"]),x.value?(h(),G(le,{key:0})):b("",!0)])):b("",!0)}});export{be as default};
